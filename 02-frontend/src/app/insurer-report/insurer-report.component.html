<mat-sidenav-container>
  <mat-sidenav #snav style="width: 220px;" fixedTopGap="80" [mode]="'side'" [fixedInViewport]="true">

    <div class="ps-2 pe-1">
      <div class="row pt-2" style="width: 220px;">
        <mat-form-field>
          <mat-label>Страховая</mat-label>
          <mat-select [formControl]="searchInsurer">
            <mat-divider></mat-divider>
            <mat-option *ngFor="let insurer of insurers" [value]="insurer">
              {{ insurer.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <div class="ps-2 pe-1">
      <div class="row pt-2" style="width: 220px;">
        <mat-form-field>
          <mat-label>Тип полиса</mat-label>
          <mat-select [formControl]="searchPolicyType">
            <mat-option [value]="null">
              <em>Любой</em>
            </mat-option>
            <mat-divider></mat-divider>
            <mat-option *ngFor="let policyType of policyTypes" [value]="policyType">
              {{ policyType.type }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <div class="ps-2 pe-1">
      <div class="row pt-2" style="width: 220px;">
        <mat-form-field>
          <mat-label>Оплата</mat-label>
          <mat-select [formControl]="searchPolicyType">
            <mat-option [value]="null">
              <em>Любая</em>
            </mat-option>
            <mat-divider></mat-divider>
            <mat-option *ngFor="let paymentType of paymentTypes" [value]="paymentType">
              {{ paymentType.type }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div>

    <div class="ps-2 pe-1 pt-2">
      <div class="row" style="width: 220px;">
        <mat-label>Начало</mat-label>
        <mat-form-field>
          <input matInput
                 [matDatepicker]="startPicker"
                 [formControl]="searchDateStart"
          >
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <div class="ps-2 pe-1">
      <div class="row" style="width: 220px;">
        <mat-label>Конец</mat-label>
        <mat-form-field>
          <input matInput
                 [matDatepicker]="endPicker"
                 [formControl]="searchDateEnd"
          >
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>
    </div>

    <div class="ps-2 pe-1">
      <div class="row pt-2" style="width: 208px;">
        <mat-button-toggle-group class="toggle-group" [formControl]="periodType">
          <mat-button-toggle class="toggle-button" value="date">Плат</mat-button-toggle>
          <mat-button-toggle class="toggle-button" value="conclude">Закл.</mat-button-toggle>
        </mat-button-toggle-group>
      </div>
    </div>

    <div class="ps-2 pe-1">
      <div class="row pt-2" style="width: 200px;">
        <div class="col-4">
          <button mat-stroked-button color="primary" style="width: 100%" (click)="getParts(ALL)">
            Все
          </button>
        </div>
        <div class="col-4">
          <button mat-stroked-button color="primary" style="width: 100%" (click)="getParts(PAID)">
            Оплач.
          </button>
        </div>
        <div class="col-4">
          <button mat-stroked-button color="primary" style="width: 100%" (click)="getParts(UNPAID)">
            Долг
          </button>
        </div>
      </div>
    </div>

    <div class="ps-2 pt-5 pe-1" *ngIf="policyParts && policyParts.length">
      <div class="row" style="width: 200px;">
        <div class="col-12">
          <button mat-stroked-button color="primary" style="width: 200px" (click)="generateExcelReport()">
            <mat-icon>table_view</mat-icon>
            Excel
          </button>
        </div>
      </div>
    </div>

    <div class="ps-2 pt-5 pe-1" *ngIf="paymentsSum > 0">
      <div class="row" style="width: 200px;">
        <div class="col-7">
          <h4>Платежи: </h4>
        </div>
        <div class="col-5">
          <h4>{{ paymentsSum | currency:'EUR':'symbol':'1.2-2' }} </h4>
        </div>
      </div>
      <div class="row" style="width: 200px;">
        <div class="col-7">
          <h4>Провизия: </h4>
        </div>
        <div class="col-5">
          <h4>{{ provisionsSum | currency:'EUR':'symbol':'1.2-2' }} </h4>
        </div>
      </div>
    </div>


  </mat-sidenav>

  <mat-sidenav-content>

    <div class="container-xxl pt-5">

      <button mat-icon-button (click)="snav.toggle()" class="sidenav-button">
        <mat-icon>menu</mat-icon>
      </button>

      <table mat-table [dataSource]="policyParts" class="mat-elevation-z8" #partsTable>

        <ng-container matColumnDef="m">
          <th mat-header-cell *matHeaderCellDef>
          </th>
          <td mat-cell *matCellDef="let policyPart" class="truncate-text" class="centered-button-cell">
            <div class="centered-button-container">
              <button mat-icon-button [matMenuTriggerFor]="menu">
                <mat-icon>more_vert</mat-icon>
              </button>
            </div>

            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="openPolicyModal(policyPart.policy, policy_modal)">Полис</button>
              <button mat-menu-item (click)="openPolicyFolder(policyPart.policy.folder)">Папка</button>
              <button mat-menu-item (click)="onEditClientModal(policyPart.policy.client, client_edit_modal)">Клиент</button>
            </mat-menu>

          </td>
        </ng-container>

        <ng-container matColumnDef="policyType">
          <th mat-header-cell *matHeaderCellDef>
            Тип
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.policy.policyType.type}} </td>
        </ng-container>

        <ng-container matColumnDef="client">
          <th mat-header-cell *matHeaderCellDef>
            Клиент
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.policy.client.name}} </td>
        </ng-container>

        <ng-container matColumnDef="object">
          <th mat-header-cell *matHeaderCellDef>
            Объект
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.policy.object}} </td>
        </ng-container>

        <ng-container matColumnDef="insurer">
          <th mat-header-cell *matHeaderCellDef>
            СК
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.policy.insurer.name}} </td>
        </ng-container>

        <ng-container matColumnDef="agent">
          <th mat-header-cell *matHeaderCellDef>
            Аг.
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.policy.agent.prefix}} </td>
        </ng-container>

        <ng-container matColumnDef="policy">
          <th mat-header-cell *matHeaderCellDef>
            Полис
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text bold" (dblclick)="openPolicyModal(part.policy, policy_modal)"> {{part.policy.policyNumber}} </td>
        </ng-container>

        <ng-container matColumnDef="start">
          <th mat-header-cell *matHeaderCellDef>
            Начало
          </th>
          <td mat-cell *matCellDef="let part"
              class="truncate-text"> {{ part.policy.startDate | date: "dd.MM.yy" }}</td>
        </ng-container>

        <ng-container matColumnDef="end">
          <th mat-header-cell *matHeaderCellDef>
            Конец
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{ part.policy.endDate | date: "dd.MM.yy" }}</td>
        </ng-container>

        <ng-container matColumnDef="parts">
          <th mat-header-cell *matHeaderCellDef>
            Ч
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.policy.parts}}/{{part.part}} </td>
        </ng-container>

        <ng-container matColumnDef="policySum">
          <th mat-header-cell *matHeaderCellDef>
            Сумма
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.policy.sum}} </td>
        </ng-container>

        <ng-container matColumnDef="paymentType">
          <th mat-header-cell *matHeaderCellDef>
            Опл.
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.policy.paymentType.prefix}} </td>
        </ng-container>

        <ng-container matColumnDef="paymentDate">
          <th mat-header-cell *matHeaderCellDef>
            Срок опл.
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{ part.date | date: "dd.MM.yy" }}</td>
        </ng-container>

        <ng-container matColumnDef="paidDate">
          <th mat-header-cell *matHeaderCellDef>
            Дата опл.
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{ part.datePaid | date: "dd.MM.yy" }}</td>
        </ng-container>

        <ng-container matColumnDef="invoice">
          <th mat-header-cell *matHeaderCellDef>
            Счет
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.invoice?.invoiceNumber}} </td>
        </ng-container>

        <ng-container matColumnDef="partSum">
          <th mat-header-cell *matHeaderCellDef>
            Платеж
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.sum}} </td>
        </ng-container>

        <ng-container matColumnDef="partSumReal">
          <th mat-header-cell *matHeaderCellDef>
            Оплач.
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.sumReal != 0 ? part.sumReal : ''}} </td>
        </ng-container>

        <ng-container matColumnDef="percent">
          <th mat-header-cell *matHeaderCellDef>
            %
          </th>
          <td mat-cell *matCellDef="let part" class="truncate-text"> {{part.policy.percent}} </td>
        </ng-container>

        <ng-container matColumnDef="provision">
          <th mat-header-cell *matHeaderCellDef>
            Пр.
          </th>
          <td mat-cell *matCellDef="let part"
              class="truncate-text"> {{ part.sum / 100 * part.policy.percent | number:'1.2-2' }} </td>
        </ng-container>


        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

    </div>

  </mat-sidenav-content>
</mat-sidenav-container>


<!-- Policy Modal -->
<ng-template #policy_modal>
  <div class="card">
    <div class="card-body">
      <div class="row">
        <div class="card-title pb-2 d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <h2 class="mb-0">Полис {{ modalPolicy.policyNumber }}</h2>
            <button type="button" class="btn btn-secondary ms-2" (click)="onModalLockButtonClicked()">
              <i *ngIf="modalPolicyLocked" class="bi bi-lock"></i>
              <i *ngIf="!modalPolicyLocked" class="bi bi-unlock"></i>
            </button>
          </div>
          <button type="button" class="btn btn-outline-secondary ms-2" (click)="modalRef.hide()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div>
        <tabset>
          <tab heading="Данные полиса" id="tab1">

            <div class="row pt-3">
              <!--Колонка с типом полиса и страховщиком начало-->
              <div class="col-5">
                <div class="row">
                  <div class="col-6">
                    <mat-form-field appearance="fill">
                      <mat-label>Тип полиса</mat-label>
                      <mat-select [formControl]="modalPolicyType">
                        <mat-option *ngFor="let policyType of policyTypes" [value]="policyType">
                          {{ policyType.type }}
                        </mat-option>
                      </mat-select>
                      <mat-error *ngIf="modalPolicyType.hasError('required')">Выберите тип!</mat-error>
                    </mat-form-field>
                  </div>

                  <div class="col-6">
                    <mat-form-field appearance="fill">
                      <mat-label>Страховщик</mat-label>
                      <mat-select [formControl]="modalPolicyInsurer">
                        <mat-option *ngFor="let insurer of insurers" [value]="insurer">
                          {{ insurer.name }}
                        </mat-option>
                      </mat-select>
                      <mat-error *ngIf="modalPolicyInsurer.hasError('required')">Выберите страховщика!</mat-error>
                    </mat-form-field>
                  </div>
                </div>

                <!--Ряд с клиентом и кнопкой-->
                <div class="row">
                  <div class="col-12">

                    <app-client-select
                      [clients]="clients"
                      [modalPolicy]="modalPolicy"
                      [modalPolicyLocked]="modalPolicyLocked"
                      (clientSelected)="setPolicyClient($event)"
                    ></app-client-select>
                  </div>
                </div>
              </div>
              <!--Колонка с типом полиса и страховщиком конец-->

              <!--Колонка с папкой и объектом-->
              <div class="col-4">

                <!--Ряд с папкой-->
                <div class="row">
                  <div class="col-12">
                    <button mat-stroked-button
                            color="primary"
                            class="mat-button w-100"
                            style="height: 52px; margin-bottom: 18px"
                            (click)="openPolicyFolder(modalPolicy.folder)">
                      <i class="bi bi-folder2-open"></i>&nbsp;&nbsp; {{modalPolicy.folder}}
                    </button>

                  </div>
                </div>

                <div class="row">
                  <div class="col-12">

                    <mat-form-field appearance="fill" style="width: 100%">
                      <mat-label>Объект</mat-label>
                      <input matInput placeholder="Объект"
                             [formControl]="modalPolicyObject">
                    </mat-form-field>

                  </div>

                </div>

              </div>

              <div class="col-3">
                <div class="row">
                  <div class="col-12 d-flex justify-content-end">
                    <mat-form-field appearance="fill">
                      <mat-label>Агент</mat-label>
                      <mat-select [formControl]="modalPolicyAgent">
                        <mat-option *ngFor="let agent of agents" [value]="agent">
                          {{ agent.prefix }}
                        </mat-option>
                      </mat-select>
                      <mat-error *ngIf="modalPolicyAgent.hasError('required')">Выберите агента!</mat-error>
                    </mat-form-field>
                  </div>
                </div>


                <div class="row">
                  <div class="col-12 d-flex justify-content-end">
                    <mat-form-field appearance="fill">
                      <mat-label>Оплата</mat-label>
                      <mat-select [formControl]="modalPolicyPaymentType">
                        <mat-option *ngFor="let type of paymentTypes" [value]="type">
                          {{ type.type }}
                        </mat-option>
                      </mat-select>
                      <mat-error *ngIf="modalPolicyPaymentType.hasError('required')">Выберите способ оплаты!</mat-error>
                    </mat-form-field>
                  </div>
                </div>


              </div>
            </div>

            <div class="row pt-3">
              <div class="col-5">
                <div class="row">
                  <div class="col-6">
                    <mat-form-field appearance="fill">
                      <mat-label>Номер полиса</mat-label>
                      <input matInput placeholder="Номер полиса" [formControl]="modalPolicyNumber">
                    </mat-form-field>
                  </div>

                  <div class="col-2">
                    <mat-form-field appearance="fill" class="datepicker-width">
                      <mat-label>Дата</mat-label>
                      <input class="datepicker-width" matInput
                             [matDatepicker]="conclusionDate"
                             [(ngModel)]="modalPolicy.conclusionDate"
                             [disabled]="modalPolicyLocked"
                             (dblclick)="setAutoDay('conclusionDate')">
                      <mat-datepicker-toggle matSuffix [for]="conclusionDate"></mat-datepicker-toggle>
                      <mat-datepicker #conclusionDate></mat-datepicker>
                    </mat-form-field>
                  </div>

                </div>

              </div>

              <div class="col-7">
                <div class="row">

                  <div class="col-4">
                    <mat-form-field appearance="fill" class="datepicker-width">
                      <mat-label>Начало</mat-label>
                      <input class="datepicker-width" matInput
                             [matDatepicker]="startDate"
                             [(ngModel)]="modalPolicy.startDate"
                             [disabled]="modalPolicyLocked"
                             (dblclick)="setAutoDay('startDate')"
                             (dateChange)="onModalPolicyPartsChange()"
                      >
                      <mat-datepicker-toggle matSuffix [for]="startDate"></mat-datepicker-toggle>
                      <mat-datepicker #startDate></mat-datepicker>
                    </mat-form-field>
                  </div>


                  <div class="col-4">
                    <mat-form-field appearance="fill" class="datepicker-width">
                      <mat-label>Конец</mat-label>
                      <input class="datepicker-width" matInput
                             [matDatepicker]="endDate"
                             [(ngModel)]="modalPolicy.endDate"
                             [disabled]="modalPolicyLocked"
                             (dblclick)="setAutoDay('endDate')">
                      <mat-datepicker-toggle matSuffix [for]="endDate"></mat-datepicker-toggle>
                      <mat-datepicker #endDate></mat-datepicker>
                    </mat-form-field>
                  </div>

                  <div class="col-4">
                    <mat-form-field appearance="fill" class="datepicker-width">
                      <mat-label>Напоминание</mat-label>
                      <input class="datepicker-width" matInput
                             [matDatepicker]="reminderDate"
                             [(ngModel)]="modalPolicy.reminderDate"
                             [disabled]="modalPolicyLocked"
                             (dblclick)="setAutoDay('reminderDate')">
                      <mat-datepicker-toggle matSuffix [for]="reminderDate"></mat-datepicker-toggle>
                      <mat-datepicker #reminderDate></mat-datepicker>
                    </mat-form-field>
                  </div>
                </div>

              </div>
            </div>

            <div class="row">
              <div class="col-5">
                <div class="row">
                  <div class="col-6">
                    <div class="row">
                      <div class="col-6">
                        <mat-form-field appearance="fill" class="short-input">
                          <mat-label>Сумма</mat-label>
                          <input
                            matInput
                            placeholder="Сумма"
                            [formControl]="modalPolicySum"
                            pattern="^\d+(\.\d{0,2})?$"
                            title="Введите правильную сумму"
                            [disabled]="modalPolicyLocked"
                            (change)="onModalPolicyPartsChange()"
                          />
                        </mat-form-field>
                      </div>
                      <div class="col-6">
                        <mat-form-field appearance="fill" class="short-input">
                          <mat-label>Части</mat-label>
                          <mat-select [formControl]="modalPolicyTotalParts"
                                      (selectionChange)="onModalPolicyPartsChange()">
                            <mat-option *ngFor="let part of parts" [value]="part">
                              {{ part }}
                            </mat-option>
                          </mat-select>
                          <mat-error *ngIf="modalPolicyTotalParts.hasError('required')">Выберите количество частей!
                          </mat-error>
                        </mat-form-field>
                      </div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="row">
                      <div class="col-6">
                        <mat-form-field appearance="fill" class="short-input">
                          <mat-label>%</mat-label>
                          <input
                            matInput
                            placeholder="% провизии"
                            [formControl]="modalPolicyPercent"
                            pattern="^(100(\.0{1,2})?|[1-9]?\d(\.\d{1,2})?)$"
                            (dblclick)="setAutoPercent()"
                          />
                        </mat-form-field>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-7">
                <div class="row">
                  <div class="col-4">
                    <mat-form-field appearance="fill" class="datepicker-width">
                      <mat-label>Остановлен</mat-label>
                      <input class="datepicker-width" matInput
                             [matDatepicker]="stopDate"
                             [(ngModel)]="modalPolicy.stopDate"
                             [disabled]="modalPolicyLocked"
                             (dblclick)="setAutoDay('stopDate')">
                      <mat-datepicker-toggle matSuffix [for]="stopDate"></mat-datepicker-toggle>
                      <mat-datepicker #stopDate></mat-datepicker>
                    </mat-form-field>
                  </div>
                  <div class="col-4"></div>
                  <div class="col-4 d-flex align-items-center">
                    <mat-checkbox [(ngModel)]="modalPolicy.reminder">Напоминать</mat-checkbox>
                  </div>
                </div>
              </div>
            </div>


            <div class="row pt-3">
              <div class="col-10">
                <div *ngFor="let part of modalPolicyParts; index as i">
                  <div class="row">

                    <div class="col d-flex align-items-center justify-content-center">
                      <h4>{{ (i + 1) }}.</h4>
                    </div>

                    <div class="col">
                      <mat-form-field appearance="fill" class="datepicker-part">
                        <mat-label>Дата</mat-label>
                        <input class="datepicker-width" matInput [matDatepicker]="partDate"
                               [(ngModel)]="part.date"
                               [disabled]="modalPolicyLocked">
                        <mat-datepicker-toggle matSuffix [for]="partDate"></mat-datepicker-toggle>
                        <mat-datepicker #partDate></mat-datepicker>
                      </mat-form-field>
                    </div>

                    <div class="col">
                      <mat-form-field appearance="fill" class="short-input">
                        <mat-label>Сумма</mat-label>
                        <input
                          matInput
                          placeholder="Сумма"
                          [(ngModel)]="part.sum"
                          pattern="^\d+(\.\d{0,2})?$"
                          title="Введите правильную сумму"
                          [disabled]="modalPolicyLocked"
                        />
                      </mat-form-field>
                    </div>

                    <div class="col">
                      <mat-form-field appearance="fill" class="datepicker-part">
                        <mat-label>Дата оплаты</mat-label>
                        <input class="datepicker-width" matInput [matDatepicker]="partDatePaid"
                               [(ngModel)]="part.datePaid"
                               (dblclick)="setAutoPaymentDay(part)">
                        <mat-datepicker-toggle matSuffix [for]="partDatePaid"></mat-datepicker-toggle>
                        <mat-datepicker #partDatePaid></mat-datepicker>
                      </mat-form-field>
                    </div>

                    <div class="col">
                      <mat-form-field appearance="fill" class="short-input">
                        <mat-label>Оплачено</mat-label>
                        <input
                          matInput
                          placeholder="Оплачено"
                          [(ngModel)]="part.sumReal"
                          pattern="^\d+(\.\d{0,2})?$"
                        />
                      </mat-form-field>
                    </div>

                    <div class="col">
                      <mat-form-field appearance="fill" class="short-input">
                        <mat-label>Счет</mat-label>
                        <input
                          matInput
                          placeholder="Счет"
                          [value]="part.invoice?.invoiceNumber"
                          (dblclick)="openInvoiceModal(part, invoice_modal)"
                          readonly
                        />
                      </mat-form-field>
                    </div>

                    <div class="col d-flex align-items-center">
                      <mat-checkbox class="example-margin" [(ngModel)]="part.reminder">Нап. &nbsp;&nbsp;</mat-checkbox>
                      <button mat-icon-button
                              *ngIf="modalPolicyPartsExcelStatus[this.modalPolicyParts.indexOf(part)] === true || modalPolicyPartsExcelStatus[this.modalPolicyParts.indexOf(part)] === false"
                              [matMenuTriggerFor]="excelMenu"
                              [ngClass]="{'button-green': modalPolicyPartsExcelStatus[this.modalPolicyParts.indexOf(part)] === true, 'button-red': modalPolicyPartsExcelStatus[this.modalPolicyParts.indexOf(part)] === false}">
                        <mat-icon>more_vert</mat-icon>
                      </button>

                      <mat-spinner
                        *ngIf="modalPolicyPartsExcelStatus[this.modalPolicyParts.indexOf(part)] === undefined"
                        [diameter]="26"></mat-spinner>

                    </div>

                    <mat-menu #excelMenu="matMenu">
                      <button mat-menu-item (click)="checkPartExcel(part)">Проверить в Excel</button>
                      <button mat-menu-item (click)="insertPartExcel(part)">Добавить в Excel</button>
                    </mat-menu>

                  </div>


                </div>
              </div>

              <!--comment col-->
              <div class="col-2">
                <div class="row">
                  <mat-form-field class="example-full-width">
                    <mat-label>Комментарий</mat-label>
                    <textarea [(ngModel)]="modalPolicy.comment" matInput></textarea>
                  </mat-form-field>
                </div>

              </div>

            </div>


          </tab>
          <tab heading="Файлы и рассылки" (selectTab)="onMailingTabSelect()">
            <div class="row pt-3">
              <div class="col-7">
                <div class="row">
                  <mat-form-field appearance="fill" style="width: 100%">
                    <mat-label>Тема</mat-label>
                    <input matInput
                           placeholder="Тема"
                           [formControl]="tabMailSubject">
                  </mat-form-field>
                </div>
                <div class="row">
                  <mat-form-field appearance="fill">
                    <mat-label>Файлы</mat-label>
                    <mat-select [formControl]="tabFilesSelected" multiple>
                      <mat-option *ngFor="let file of policyFiles" [value]="file">{{file}}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="row">
                  <div class="col-6">
                    <div class="row">
                      <mat-form-field appearance="fill" style="width: 100%">
                        <mat-label>Email 1</mat-label>
                        <input matInput placeholder="Email 1"
                               [formControl]="tabEmail1">
                      </mat-form-field>
                    </div>

                    <div class="row">
                      <mat-form-field appearance="fill" style="width: 100%">
                        <mat-label>Email 2</mat-label>
                        <input matInput placeholder="Email 2"
                               [formControl]="tabEmail2">
                      </mat-form-field>
                    </div>

                    <div class="row">
                      <mat-form-field appearance="fill" style="width: 100%">
                        <mat-label>Email 3</mat-label>
                        <input matInput placeholder="Email 3"
                               [formControl]="tabEmail3">
                      </mat-form-field>
                    </div>

                    <div class="row">
                      <mat-form-field appearance="fill" style="width: 100%">
                        <mat-label>Банк/лизинг</mat-label>
                        <mat-select [formControl]="tabBank">
                          <mat-option [value]="null">
                            <em>Не выбрано</em>
                          </mat-option>
                          <mat-divider></mat-divider>
                          <mat-option *ngFor="let bank of banks" [value]="bank">
                            {{ bank.name }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>

                  </div>

                  <div class="col-6">
                    <div class="row">
                      <mat-form-field appearance="fill" style="width: 100%">
                        <mat-label>Текст письма</mat-label>
                        <textarea matInput [formControl]="tabMailBody" style="height: 157px"></textarea>
                      </mat-form-field>
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                      <button
                        [disabled]="tabEmailLoading"
                        mat-stroked-button
                        color="primary"
                        (click)="sendTabEmail()"
                      >
                        <mat-icon>mail</mat-icon>
                      </button>
                      <mat-spinner *ngIf="tabEmailLoading" [diameter]="26"></mat-spinner>
                      <mat-checkbox class="example-margin" [(ngModel)]="sendMeCopy">
                        <div class="text-right">Отправить мне копию</div>
                      </mat-checkbox>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-1"></div>

              <div class="col-4">
                <div class="row">
                  <mat-form-field appearance="fill" style="width: 100%">
                    <mat-label>Отправитель</mat-label>
                    <input matInput placeholder="Email 3"
                           [formControl]="tabSmsSender">
                  </mat-form-field>
                </div>

                <div class="row">
                  <mat-form-field appearance="fill" style="width: 100%">
                    <mat-label>Получатель</mat-label>
                    <input matInput placeholder="Email 3"
                           [formControl]="tabSmsReceiver">
                  </mat-form-field>
                </div>

                <div class="row">
                  <mat-form-field appearance="fill" style="width: 100%">
                    <mat-label>Текст SMS</mat-label>
                    <textarea matInput [formControl]="tabSmsText" style="height: 157px"></textarea>
                  </mat-form-field>
                  <div class="d-flex align-items-center justify-content-between">
                    <button [disabled]="tabSmsLoading" mat-stroked-button color="primary" (click)="sendSms()">
                      <mat-icon>sms</mat-icon>
                    </button>

                    <mat-spinner *ngIf="tabSmsLoading" [diameter]="26"></mat-spinner>

                    <button mat-stroked-button
                            *ngIf="tabSmsLanguageRus"
                            color="primary"
                            class="mat-button" style="height: 52px;"
                            (click)="smsChangeLanguage()">
                      RUS
                    </button>

                    <button mat-stroked-button
                            *ngIf="!tabSmsLanguageRus"
                            color="primary"
                            class="mat-button" style="height: 52px;"
                            (click)="smsChangeLanguage()">
                      EST
                    </button>

                  </div>
                </div>
              </div>

            </div>

            <div class="pt-3" id="logs" *ngIf="modalPolicyLogs?.length">
              <h3>История рассылок и SMS:</h3>
              <div *ngFor="let log of modalPolicyLogs">
                <div class="row">
                  <h4>{{ log }}</h4>
                </div>
              </div>
            </div>


          </tab>
          <tab heading="Калькуляции" *ngIf="modalPolicy.policyType?.type == 'Liiklus'">Basic content 2</tab>
        </tabset>
      </div>

      <div class="d-flex justify-content-end pt-3">
        <button mat-stroked-button color="primary" class="me-2" (click)="modalPolicySave()">Сохранить</button>
        <button mat-stroked-button color="warn" (click)="modalRef.hide()">Отмена</button>
      </div>

    </div>
  </div>
</ng-template>

<!-- Invoice Modal -->
<ng-template #invoice_modal>
  <div class="card">
    <div class="card-body">
      <div class="row">
        <div class="card-title pb-2 d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <h2 class="mb-0">Счет {{ modalInvoice.invoiceNumber }}</h2>
          </div>
          <button type="button" class="btn btn-outline-secondary ms-2" (click)="modalRef2.hide()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div class="row pt-3">
        <div class="col-3">
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Полис</mat-label>
              <input matInput placeholder="Полис"
                     [(ngModel)]="modalPart.policy.policyNumber"
                     readonly>
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Часть</mat-label>
              <input matInput placeholder="Часть"
                     [(ngModel)]="modalPart.part"
                     readonly>
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Клиент</mat-label>
              <input matInput placeholder="Клиент"
                     [(ngModel)]="modalPart.policy.client.name"
                     readonly>
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Рег. код</mat-label>
              <input matInput placeholder="Рег. код"
                     [(ngModel)]="modalPart.policy.client.code"
                     readonly>
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field class="example-full-width" appearance="fill" style="width: 100%">
              <mat-label>Адрес</mat-label>
              <textarea [(ngModel)]="modalPart.policy.client.address" matInput readonly></textarea>
            </mat-form-field>
          </div>
        </div>


        <div class="col-3">
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Счет</mat-label>
              <input matInput placeholder="Счет"
                     [(ngModel)]="modalInvoice.invoiceNumber"
                     readonly>
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Дата</mat-label>
              <input matInput [matDatepicker]="partDate"
                     [(ngModel)]="modalInvoice.conclusionDate"
                     readonly>
              <mat-datepicker-toggle matSuffix [for]="partDate" disabled></mat-datepicker-toggle>
              <mat-datepicker #partDate></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Срок оплаты (ред.)</mat-label>
              <input matInput [matDatepicker]="partMaxDate"
                     [(ngModel)]="modalInvoice.maxDate">
              <mat-datepicker-toggle matSuffix [for]="partMaxDate"></mat-datepicker-toggle>
              <mat-datepicker #partMaxDate></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Оплачено (ред.)</mat-label>
              <input matInput [matDatepicker]="partPaidDate"
                     [(ngModel)]="modalInvoice.paidDate">
              <mat-datepicker-toggle matSuffix [for]="partPaidDate"></mat-datepicker-toggle>
              <mat-datepicker #partPaidDate></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Сумма</mat-label>
              <input matInput placeholder="Сумма"
                     [(ngModel)]="modalPart.sum"
                     readonly>
            </mat-form-field>
          </div>
        </div>


        <div class="col-6 ps-4">
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Заголовок счета</mat-label>
              <input matInput
                     value="{{ modalPart.policy.insurer.name }} kindlustuse poliis"
                     readonly>
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field class="example-full-width" appearance="fill" style="width: 100%">
              <mat-label>Текст счета (ред.)</mat-label>
              <textarea [(ngModel)]="modalInvoice.text" matInput style="height: 86px"></textarea>
            </mat-form-field>
          </div>

          <button mat-stroked-button color="primary"
                  (click)="generateInvoice()">
            <mat-icon>picture_as_pdf</mat-icon>
          </button>

        </div>
      </div>

      <div class="row pt-3">
        <div class="col-8">

          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Тема (ред.)</mat-label>
              <input matInput
                     placeholder="Тема"
                     [formControl]="mailSubject">
            </mat-form-field>
          </div>

          <div class="row">
            <mat-form-field appearance="fill">
              <mat-label>Файлы</mat-label>
              <mat-select [formControl]="filesSelected" multiple>
                <mat-option *ngFor="let file of policyFiles" [value]="file">{{file}}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="row">
            <div class="col-5">
              <div class="row">
                <mat-form-field appearance="fill" style="width: 100%">
                  <mat-label>Email 1 (ред.)</mat-label>
                  <input matInput placeholder="Email 1"
                         [formControl]="email1">
                </mat-form-field>
              </div>

              <div class="row">
                <mat-form-field appearance="fill" style="width: 100%">
                  <mat-label>Email 2 (ред.)</mat-label>
                  <input matInput placeholder="Email 2"
                         [formControl]="email2">
                </mat-form-field>
              </div>

              <div class="row">
                <mat-form-field appearance="fill" style="width: 100%">
                  <mat-label>Email 3 (ред.)</mat-label>
                  <input matInput placeholder="Email 3"
                         [formControl]="email3">
                </mat-form-field>
              </div>
            </div>

            <div class="col-7">
              <div class="row">
                <mat-form-field appearance="fill" style="width: 100%">
                  <mat-label>Текст письма (ред.)</mat-label>
                  <textarea matInput [formControl]="mailBody" style="height: 86px"></textarea>
                </mat-form-field>
              </div>

              <div class="d-flex align-items-center justify-content-between">
                <button
                  [disabled]="tabEmailLoading"
                  mat-stroked-button
                  color="primary"
                  (click)="sendInvoiceEmail()"
                >
                  <mat-icon>mail</mat-icon>
                </button>
                <mat-spinner *ngIf="tabEmailLoading" [diameter]="26"></mat-spinner>
                <mat-checkbox class="example-margin" [(ngModel)]="sendMeCopy">
                  <div class="text-right">Отправить мне копию</div>
                </mat-checkbox>
              </div>
            </div>
          </div>
        </div>

        <div class="col-4">
          <div class="row">
            <p>Text text</p>
          </div>
        </div>

      </div>
    </div>
  </div>

</ng-template>

<!-- Edit Client modal -->
<ng-template #client_edit_modal>
  <div class="card">
    <div class="card-body">
      <div class="row">
        <div class="card-title pb-2 d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <h2 class="mb-0">Редактировать клиента</h2>
          </div>
          <button type="button" class="btn btn-outline-secondary ms-2" (click)="modalRef.hide()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div class="row pt-3">

        <div class="col-4">
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Имя</mat-label>
              <input matInput placeholder="Имя"
                     [(ngModel)]="selectedClient.name">
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Код</mat-label>
              <input matInput placeholder="Код"
                     [(ngModel)]="selectedClient.code">
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Адрес</mat-label>
              <input matInput placeholder="Адрес"
                     [(ngModel)]="selectedClient.address">
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Телефон</mat-label>
              <input matInput placeholder="Телефон"
                     [(ngModel)]="selectedClient.phone">
            </mat-form-field>
          </div>
        </div>

        <div class="col-4">
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Представитель</mat-label>
              <input matInput placeholder="Представитель"
                     [(ngModel)]="selectedClient.representative">
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Email 1</mat-label>
              <input matInput placeholder="Email 1"
                     [(ngModel)]="selectedClient.email1">
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Email 2</mat-label>
              <input matInput placeholder="Email 2"
                     [(ngModel)]="selectedClient.email2">
            </mat-form-field>
          </div>

          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Email 3</mat-label>
              <input matInput placeholder="Email 3"
                     [(ngModel)]="selectedClient.email3">
            </mat-form-field>
          </div>
        </div>

        <div class="col-4">
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Мобильный 1</mat-label>
              <input matInput placeholder="Мобильный 1"
                     [(ngModel)]="selectedClient.mobile1">
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Мобильный 2</mat-label>
              <input matInput placeholder="Мобильный 2"
                     [(ngModel)]="selectedClient.mobile2">
            </mat-form-field>
          </div>
          <div class="row">
            <div class="col-12 d-flex justify-content-end">
              <mat-form-field appearance="fill" style="width: 100%">
                <mat-label>Банк</mat-label>
                <mat-select [formControl]="selectedClientBank">
                  <mat-option *ngFor="let bank of banks" [value]="bank">
                    {{ bank.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>

          <div class="row">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Банковский счет</mat-label>
              <input matInput placeholder="Банковский счет"
                     [(ngModel)]="selectedClient.bankAccount">
            </mat-form-field>
          </div>
        </div>
      </div>

      <div class="row pt-3">
        <div class="row">
          <mat-form-field appearance="fill" style="width: 100%">
            <mat-label>Комментарий</mat-label>
            <textarea matInput [(ngModel)]="selectedClient.comment"></textarea>
          </mat-form-field>
        </div>
      </div>

      <div class="d-flex justify-content-end pt-3">
        <button mat-stroked-button color="primary" class="me-2" (click)="onClientSave()">Сохранить</button>
        <button mat-stroked-button color="warn" (click)="modalRef.hide()">Отмена</button>
      </div>

    </div>
  </div>
</ng-template>
